<!--
  ~ Licensed to the Apache Software Foundation (ASF) under one or more
  ~ contributor license agreements. See the NOTICE file distributed with
  ~ this work for additional information regarding copyright ownership.
  ~ The ASF licenses this file to You under the Apache License, Version 2.0
  ~ (the "License"); you may not use this file except in compliance with
  ~ the License.  You may obtain a copy of the License at
  ~
  ~      http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
        rel="stylesheet"
        href="styles/patternfly.css"
        crossorigin="anonymous"
    >
    <title>Food Market - 1.0-SNAPSHOT</title>
</head>
<body>
<div class="pf-c-page" id="food-market">
    <a class="pf-c-skip-to-content pf-c-button pf-m-primary" href="#main-content-food-market">Skip to content</a>
    <header class="pf-c-page__header">
        <div class="pf-c-page__header-brand">
            <div class="pf-c-page__header-brand-toggle">
                <button class="pf-c-button pf-m-plain" type="button" id="food-market-nav-toggle" aria-label="Global navigation" aria-expanded="true" aria-controls="food-market-primary-nav">
                    <i class="fas fa-bars" aria-hidden="true"></i>
                </button>
            </div>
        </div>
    </header>
    <div class="pf-c-page__sidebar">
        <div class="pf-c-page__sidebar-body">
            <nav class="pf-c-nav" id="food-market-primary-nav" aria-label="Global">
                <ul class="pf-c-nav__list">
                    <li class="pf-c-nav__item">
                        <a href="#" class="pf-c-nav__link pf-m-current" aria-current="page">Fruits</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
    <main class="pf-c-page__main" tabindex="-1">
        <section class="pf-c-page__main-section pf-m-light">
            <div class="pf-c-content">
                <h1>Food Market demo</h1>
            </div>
        </section>
        <section class="pf-c-page__main-section pf-m-no-padding pf-m-padding-on-xl">
            <div class="pf-c-content">
                <h3 class="pf-c-title pf-m-lg">Bookings</h3>
            </div>
            <div class="pf-c-card">
                <table class="pf-c-table pf-m-grid-xl" role="grid" aria-label="This is a table with checkboxes" id="bookings">
                    <thead>
                    <tr role="row">
                        <th role="columnheader" scope="col">Id</th>
                        <th role="columnheader" scope="col">Client</th>
                        <th role="columnheader" scope="col">Product</th>
                        <th role="columnheader" scope="col">Amount</th>
                        <th role="columnheader" scope="col">Price</th>
                        <th role="columnheader" scope="col">Status</th>
                        <td role="cell"></td>
                    </tr>
                    </thead>
                    <tbody role="rowgroup">
                    {#for booking in bookings}
                    <tr role="row">
                        <th role="columnheader" data-label="Id">
                            <span>#{booking.id}</span>
                        </th>
                        <td role="cell" data-label="Client">
                            <span>{booking.client}</span>
                        </td>
                        <td role="cell" data-label="Product">
                            <span>{booking.product.name}</span>
                        </td>
                        <td role="cell" data-label="Amount">
                            {#if booking.amount}
                            <span>{booking.amount}</span>
                            {#else}
                            <span>0</span>
                            {/if}
                        </td>
                        <td role="cell" data-label="Price">
                            {#if booking.price}
                            <span>{booking.price}</span>
                            {#else}
                            <span>0.00</span>
                            {/if}
                        </td>
                        <td role="cell" data-label="Status">
                            <span>{booking.status}</span>
                        </td>
                        <td role="cell" data-label="Action">
                            {#when booking.status}
                                {#is APPROVAL_REQUIRED}
                                <a id="{booking.id}" href="#" class="approve-booking"><i class="fas fa-check" aria-hidden="true"></i> APPROVE</a>
                                {#is in PENDING COMPLETED}
                                <a id="{booking.id}" href="#" class="view-booking"><i class="fas fa-search" aria-hidden="true"></i> VIEW</a>
                            {/when}
                        </td>
                    </tr>
                    {/for}
                    </tbody>
                </table>
            </div>
        </section>
        <section class="pf-c-page__main-section pf-m-no-padding pf-m-padding-on-xl">
            <div class="pf-c-content">
                <h3 class="pf-c-title pf-m-lg">Supplies</h3>
            </div>
            <div class="pf-c-card">
                <table class="pf-c-table pf-m-grid-xl" role="grid" aria-label="This is a table with checkboxes" id="supplies">
                    <thead>
                    <tr role="row">
                        <th role="columnheader" scope="col">Id</th>
                        <th role="columnheader" scope="col">Supplier</th>
                        <th role="columnheader" scope="col">Product</th>
                        <th role="columnheader" scope="col">Amount</th>
                        <th role="columnheader" scope="col">Price</th>
                        <th role="columnheader" scope="col">Status</th>
                        <td role="cell"></td>
                    </tr>
                    </thead>
                    <tbody role="rowgroup">
                    {#for supply in supplies}
                        <tr role="row">
                        <th role="columnheader" data-label="Id">
                            <span>#{supply.id}</span>
                        </th>
                        <td role="cell" data-label="Supplier">
                            <span>{supply.supplier}</span>
                        </td>
                        <td role="cell" data-label="Product">
                            <span>{supply.product.name}</span>
                        </td>
                        <td role="cell" data-label="Amount">
                            {#if supply.amount}
                                <span>{supply.amount}</span>
                            {#else}
                                <span>0</span>
                            {/if}
                        </td>
                        <td role="cell" data-label="Price">
                            {#if supply.price}
                                <span>{supply.price}</span>
                            {#else}
                                <span>0.00</span>
                            {/if}
                        </td>
                        <td role="cell" data-label="Status">
                        <span>{supply.status}</span>
                        </td>
                        <td role="cell" data-label="Action">
                            <a id="{supply.id}" href="#" class="view-supply"><i class="fas fa-search" aria-hidden="true"></i> VIEW</a>
                        </td>
                        </tr>
                    {/for}
                    </tbody>
                </table>
            </div>
        </section>
        <section class="pf-c-page__main-section pf-m-no-padding pf-m-padding-on-xl">
            <form class="pf-c-form" id="new-booking" action="/" method="post" novalidate>
                <div class="pf-l-grid pf-m-all-2-col-on-md pf-m-gutter">
                    <div class="pf-c-form__group">
                        <div class="pf-c-form__group-label"><label class="pf-c-form__label" for="type">
                                <span class="pf-c-form__label-text">Type</span></label>
                        </div>
                        <div class="pf-c-form__group-control">
                            <select
                                    class="pf-c-form-control"
                                    id="type"
                                    name="type"
                            >
                                <option value selected>Select one</option>
                                <option value="booking">BOOKING</option>
                                <option value="supply">SUPPLY</option>
                            </select>
                        </div>
                    </div>
                    <div class="pf-c-form__group">
                        <div class="pf-c-form__group-label"><label class="pf-c-form__label" for="name">
                                <span class="pf-c-form__label-text">Name</span></label>
                        </div>
                        <div class="pf-c-form__group-control">
                            <input
                                    class="pf-c-form-control"
                                    required
                                    type="text"
                                    id="name"
                                    name="name"
                            />
                        </div>
                    </div>
                    <div class="pf-c-form__group">
                        <div class="pf-c-form__group-label"><label class="pf-c-form__label" for="product">
                                <span class="pf-c-form__label-text">Product</span></label>
                        </div>
                        <div class="pf-c-form__group-control">
                            <select
                                    class="pf-c-form-control"
                                    id="product"
                                    name="product"
                            >
                                <option value selected>Select one</option>
                                {#for product in products}
                                    <option value="{product.name}">{product.name}</option>
                                {/for}
                            </select>
                        </div>
                    </div>
                    <div class="pf-c-form__group">
                        <div class="pf-c-form__group-label"><label class="pf-c-form__label" for="amount">
                                <span class="pf-c-form__label-text">Amount</span></label>
                        </div>
                        <div class="pf-c-form__group-control">
                            <input
                                    class="pf-c-form-control"
                                    required
                                    type="text"
                                    id="amount"
                                    value="0"
                                    name="amount"
                            />
                        </div>
                    </div>
                    <div class="pf-c-form__group">
                        <div class="pf-c-form__group-label"><label class="pf-c-form__label" for="price">
                                <span class="pf-c-form__label-text">Price</span></label>
                        </div>
                        <div class="pf-c-form__group-control">
                            <input
                                    class="pf-c-form-control"
                                    required
                                    type="text"
                                    id="price"
                                    value="1.00"
                                    name="price"
                            />
                        </div>
                    </div>
                    <div class="pf-c-form__group">
                        <div class="pf-c-form__group-label"><label class="pf-c-form__label" for="status">
                                <span class="pf-c-form__label-text">Status</span></label>
                        </div>
                        <div class="pf-c-form__group-control">
                            <select
                                    class="pf-c-form-control"
                                    id="status"
                                    name="status"
                            >
                                <option value selected>Select one</option>
                                <option value="PENDING">PENDING</option>
                                <option value="COMPLETED">COMPLETED</option>
                                <option value="AVAILABLE">AVAILABLE</option>
                                <option value="SOLD">SOLD</option>
                            </select>
                        </div>
                    </div>
                    <div class="pf-c-form__group pf-m-action">
                        <div class="pf-c-form__group-control">
                            <div class="pf-c-form__actions">
                                <button id="save" class="pf-c-button pf-m-primary" type="submit">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </section>
    </main>
</div>
</body>
<script src="scripts/jquery-3.3.1.min.js"></script>
<script>
    const bookings = new EventSource("/bookings");
    bookings.onmessage = function(event) {
        var booking = JSON.parse(event.data);

        console.log("Received Data:",booking)

        var tableRef = document
            .getElementById("bookings")
            .getElementsByTagName("tbody")[0];

        // Insert a row in the table at the last row
        var newRow = tableRef.insertRow();

        newRow.insertCell(0).appendChild(document.createTextNode("#" + booking.id));
        newRow.insertCell(1).appendChild(document.createTextNode(booking.client));
        newRow.insertCell(2).appendChild(document.createTextNode(booking.product.name));
        newRow.insertCell(3).appendChild(document.createTextNode(booking.amount));
        newRow.insertCell(4).appendChild(document.createTextNode(booking.price));
        newRow.insertCell(5).appendChild(document.createTextNode(booking.status));

        if (booking.status === 'APPROVAL_REQUIRED') {
            $(newRow.insertCell(6)).html("<a id=\"" + booking.id + "\" href=\"#\" class=\"approve-booking\"><i class=\"fas fa-check\" aria-hidden=\"true\"></i> APPROVE</a>");
        } else {
            $(newRow.insertCell(6)).html("<a id=\"" + booking.id + "\" href=\"#\" class=\"view-booking\"><i class=\"fas fa-search\" aria-hidden=\"true\"></i>VIEW</a>");
        }
    };

    const supplies = new EventSource("/supplies");
    supplies.onmessage = function(event) {
        var supply = JSON.parse(event.data);

        console.log("Received Data:",supply)

        var tableRef = document
            .getElementById("supplies")
            .getElementsByTagName("tbody")[0];

        // Insert a row in the table at the last row
        var newRow = tableRef.insertRow();

        newRow.insertCell(0).appendChild(document.createTextNode("#" + supply.id));
        newRow.insertCell(1).appendChild(document.createTextNode(supply.supplier));
        newRow.insertCell(2).appendChild(document.createTextNode(supply.product.name));
        newRow.insertCell(3).appendChild(document.createTextNode(supply.amount));
        newRow.insertCell(4).appendChild(document.createTextNode(supply.price));
        newRow.insertCell(5).appendChild(document.createTextNode(supply.status));
        $(newRow.insertCell(6)).html("<a id=\"" + supply.id + "\" href=\"#\" class=\"view-supply\"><i class=\"fas fa-search\" aria-hidden=\"true\"></i>VIEW</a>");
    };

    $(".approve-booking").click(function(event) {
        event.preventDefault();
        $.ajax({
            method: "PUT",
            url: "/api/bookings/approval/" + $(this).attr("id"),
        }).done(function() {
            location.reload();
        });
        event.stopPropagation();
    })

    $(document).ready(function(){
        window.history.replaceState("","",window.location.href)
    });
</script>
</html>
